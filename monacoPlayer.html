<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Monaco Player</title>
	<link rel="stylesheet" href="https://gymburgdorf-ef23.github.io/helpers/basicstyle.css"></link>
	<link rel="stylesheet" href="NeuralRacer.css"></link>
</head>
<body>
	<h1>Monaco Player</h1>
	<div class="wrap"><svg class="drawing" viewBox="0 0 800 300"></svg></div>
	<div class="score"></div>
	<div class="output"></div>
	<script src="Track.js"></script>
	<script src="NeuralNet.js"></script>
	<script src="TrackRenderer.js"></script>
	<script src="Monaco.js"></script>
	<script src="Car.js"></script>
	<script src="CarRenderer.js"></script>
	<script src="CarPlayer.js"></script>
	<script src="CarAI.js"></script>
	<script>

	const track = setupMonaco()

	const maxMoves = 100
	const nCars = 3

	const cars = []
	const scores = []
	const steps = []

	var moves = 0

	const defScore = -99
	var currentIndex = 0

	// add many cars
	for(var x = 0; x < nCars; x++) {
		const car = new CarAI(track)
		// const car = new CarPlayer(track)
		
		scores.push(defScore)
		cars.push(car)	

		const carRenderer = new CarRenderer(track)

		const myIndex = currentIndex++

		step = () => {

			car.move()

			car.updateScore()

			const done = ((++moves) >= nCars * maxMoves)
			if(done)
				moves = 0

			carRenderer.render(car, true)
			if(car.checkCollision() || done) {
				// car is dead
				scores[myIndex] = car.score

				found = false
				largestIndex = 0
				largestScore = 0
				for(var index = 0; index < scores.length; index++){
					x = scores[index]
					if(x === defScore){
						found = true
						break
					}
					if(x > largestScore){
						console.log(largestScore)
						largestScore = x
						largestIndex = index
					}
				}
				
				if(!found || done){
					console.log("Largest score: " + largestIndex + ": " + largestScore);
					winner = cars[largestIndex]

					for(var index = 0; index < cars.length; index++){
						x = cars[index]
						if(index != largestIndex) {
							x.nn = winner.nn.clone()
							
							x.nn.noise()
						}
						scores[index] = defScore
						x.reset()
						requestAnimationFrame(steps[index])
					}
				}

			} else 
			requestAnimationFrame(step)
		}
		steps.push(step)

		step()
	}


	</script>
</body>
</html>